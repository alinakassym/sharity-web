# Процесс авторизации пользователя

## Общая схема работы

При запуске Telegram Mini App происходит следующий процесс:

### 1. Проверка существования пользователя
- Приложение проверяет, запущено ли оно в Telegram
- Получает данные пользователя через Telegram API
- Проверяет наличие пользователя в базе Firebase (коллекция `users`)

### 2. Для новых пользователей
```
Старт приложения
    ↓
Экран загрузки (LoadingScreen)
    ↓
Проверка пользователя в базе
    ↓
Пользователь НЕ найден
    ↓
Модальное окно авторизации (AuthModal)
    ↓
Пользователь нажимает "Согласен"
    ↓
Сохранение данных в Firebase
    ↓
Приложение готово к использованию
```

### 3. Для существующих пользователей
```
Старт приложения
    ↓
Экран загрузки (LoadingScreen)
    ↓
Проверка пользователя в базе
    ↓
Пользователь найден
    ↓
Обновление lastLoginAt
    ↓
Приложение готово к использованию
(модальное окно НЕ показывается)
```

## Компоненты

### 1. TelegramUserInit
**Файл:** `src/components/TelegramUserInit.tsx`

Главный компонент для инициализации пользователя.

**Логика:**
- Монтируется при старте приложения (в App.tsx)
- Проверяет, что приложение в Telegram
- Вызывает `checkUserExists()` для проверки пользователя
- Показывает LoadingScreen во время проверки
- Для новых пользователей показывает AuthModal
- Для существующих - обновляет данные в фоне

### 2. LoadingScreen
**Файл:** `src/components/LoadingScreen.tsx`

Экран загрузки на полный экран.

**Отображается:**
- При первой проверке пользователя в базе
- Обычно 1-2 секунды

### 3. AuthModal
**Файл:** `src/components/AuthModal.tsx`

Модальное окно с запросом разрешения на авторизацию.

**Содержит:**
- Описание получаемых данных (имя, username, язык)
- Кнопка "Согласен" - сохраняет пользователя
- Кнопка "Отмена" - закрывает окно

**Получаемые данные:**
- ✅ Имя и фамилия
- ✅ Username (логин)
- ✅ Язык интерфейса

### 4. useRequestCreateUser
**Файл:** `src/hooks/useRequestCreateUser.ts`

Хук для работы с пользователями в Firebase.

**Методы:**
- `checkUserExists(telegramId)` - проверяет существование пользователя
- `createOrUpdateUser(userData)` - создает или обновляет пользователя

## Сценарии

### Сценарий 1: Первый запуск бота
1. Пользователь открывает бота в Telegram
2. Нажимает кнопку "Старт"
3. Видит экран загрузки
4. Появляется модальное окно с запросом авторизации
5. Нажимает "Согласен"
6. Данные сохраняются в Firebase
7. Приложение открывается

### Сценарий 2: Повторный запуск
1. Пользователь открывает бота в Telegram
2. Видит экран загрузки (1-2 сек)
3. Приложение сразу открывается (без модального окна)
4. В фоне обновляется `lastLoginAt`

### Сценарий 3: Отказ от авторизации
1. Пользователь нажимает "Отмена" в модальном окне
2. Окно закрывается
3. Пользователь не сохраняется в базе
4. При следующем запуске снова появится окно авторизации

## Техническая реализация

### Интеграция в App.tsx
```tsx
<TelegramUserInit />
```

Компонент добавлен в AppContent и рендерится только если приложение запущено в Telegram:
```tsx
{isTelegram && <TelegramUserInit />}
```

### Проверка пользователя
```typescript
const userExists = await checkUserExists(user.id);

if (userExists) {
  // Обновляем данные
  await createOrUpdateUser(userData);
} else {
  // Показываем модальное окно
  setShowAuthModal(true);
}
```

### Сохранение пользователя
```typescript
const userData = {
  telegramId: user.id,
  username: user.username,
  firstName: user.first_name,
  lastName: user.last_name,
  languageCode: user.language_code,
};

await createOrUpdateUser(userData);
```

## Безопасность

- ✅ Данные получаются только через официальный Telegram API
- ✅ Пользователь явно соглашается на получение данных
- ✅ Модальное окно показывает список получаемых данных
- ✅ ID документа в Firebase = telegramId (уникальный)
- ✅ Повторная регистрация невозможна (проверка существования)

## Логирование

Все ключевые действия логируются в консоль:
- `✅` - успешные операции
- `⚠️` - предупреждения (новый пользователь)
- `❌` - ошибки

Примеры:
```
✅ Пользователь найден, обновляем данные
⚠️ Новый пользователь, требуется авторизация
✅ Новый пользователь зарегистрирован: john_doe
❌ Ошибка при сохранении пользователя: ...
```
